{"version":3,"file":"angular-google-tag-manager.umd.js","sources":["../../projects/angular-google-tag-manager/src/lib/angular-google-tag-manager.service.ts","../../projects/angular-google-tag-manager/src/lib/angular-google-tag-manager.module.ts"],"sourcesContent":["import { Inject, Injectable, Optional } from '@angular/core';\nimport { GoogleTagManagerConfig } from './google-tag-manager-config';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class GoogleTagManagerService {\n  private isLoaded = false;\n\n  private browserGlobals = {\n    windowRef(): any {\n      return window;\n    },\n    documentRef(): any {\n      return document;\n    },\n  };\n\n  constructor(\n    @Optional()\n    @Inject('googleTagManagerConfig')\n    public config: GoogleTagManagerConfig = { id: null },\n    @Optional() @Inject('googleTagManagerId') public googleTagManagerId: string,\n    @Optional()\n    @Inject('googleTagManagerAuth')\n    public googleTagManagerAuth: string,\n    @Optional()\n    @Inject('googleTagManagerPreview')\n    public googleTagManagerPreview: string\n  ) {\n    if (this.config == null) {\n      this.config = { id: null };\n    }\n\n    this.config = {\n      ...this.config,\n      id: googleTagManagerId || this.config.id,\n      gtm_auth: googleTagManagerAuth || this.config.gtm_auth,\n      gtm_preview: googleTagManagerPreview || this.config.gtm_preview,\n    };\n    if (this.config.id == null) {\n      throw new Error('Google tag manager ID not provided.');\n    }\n  }\n\n  public getDataLayer(): any[] {\n    const window = this.browserGlobals.windowRef();\n    window.dataLayer = window.dataLayer || [];\n    return window.dataLayer;\n  }\n\n  private pushOnDataLayer(obj: object): void {\n    const dataLayer = this.getDataLayer();\n    dataLayer.push(obj);\n  }\n\n  public addGtmToDom(): Promise<boolean> {\n    return new Promise((resolve, reject) => {\n      if (this.isLoaded) {\n        return resolve(this.isLoaded);\n      }\n      const doc = this.browserGlobals.documentRef();\n      this.pushOnDataLayer({\n        'gtm.start': new Date().getTime(),\n        event: 'gtm.js',\n      });\n\n      const gtmScript = doc.createElement('script');\n      gtmScript.id = 'GTMscript';\n      gtmScript.async = true;\n      gtmScript.src = this.applyGtmQueryParams(\n        'https://www.googletagmanager.com/gtm.js'\n      );\n      gtmScript.addEventListener('load', () => {\n        return resolve(this.isLoaded = true);\n      });\n      gtmScript.addEventListener('error', () => {\n        return reject(false);\n      });\n      doc.head.insertBefore(gtmScript, doc.head.firstChild);\n    });\n  }\n\n  public pushTag(item: object): Promise<void> {\n    return new Promise<void>((resolve, reject) => {\n      if (!this.isLoaded) {\n        this.addGtmToDom().then(() => {\n          this.pushOnDataLayer(item);\n          return resolve();\n        }).catch(() => reject());\n      }\n      this.pushOnDataLayer(item);\n      return resolve();\n    });\n  }\n\n  private applyGtmQueryParams(url: string): string {\n    if (url.indexOf('?') === -1) {\n      url += '?';\n    }\n\n    return (\n      url +\n      Object.keys(this.config)\n        .filter((k) => this.config[k])\n        .map((k) => `${k}=${this.config[k]}`)\n        .join('&')\n    );\n  }\n}\n","import { NgModule, ModuleWithProviders } from '@angular/core';\nimport { GoogleTagManagerConfig } from './google-tag-manager-config';\n\n@NgModule()\nexport class GoogleTagManagerModule {\n  public static forRoot(\n    config: GoogleTagManagerConfig\n  ): ModuleWithProviders<GoogleTagManagerModule> {\n    return {\n      ngModule: GoogleTagManagerModule,\n      providers: [{ provide: 'googleTagManagerConfig', useValue: config }],\n    };\n  }\n}\n"],"names":["Injectable","Optional","Inject","NgModule"],"mappings":"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"}